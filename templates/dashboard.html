{% extends 'base.html' %}

{% block title %}{{ translate('dashboard.title') }} - QuickForm{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('quickform.dashboard') }}">QuickForm</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="{{ url_for('quickform.dashboard') }}">{{ translate('nav.dashboard') }}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('quickform.create_task') }}">{{ translate('nav.create_task') }}</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        {{ current_user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="{{ url_for('quickform.profile') }}">{{ translate('nav.profile') }}</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('quickform.logout') }}">{{ translate('nav.logout') }}</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0" style="color: #111827; font-weight: 700;">{{ translate('dashboard.my_tasks') }}</h2>
            <a href="{{ url_for('quickform.create_task') }}" class="btn btn-primary" style="font-weight: 500;">
                <i class="bi bi-plus-circle" style="margin-right: 0.375rem;"></i>{{ translate('dashboard.create_new_task') }}
            </a>
        </div>
        
        <!-- 任务统计信息卡片 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                    <div>
                        <h4 class="mb-2" style="color: #111827; font-weight: 600;">{{ translate('dashboard.task_list') }}</h4>
                        {% if not current_user.is_admin() %}
                        {% if is_certified %}
                        <div class="small">
                            <span class="status-badge featured me-2">{{ translate('dashboard.certified_teacher') }}</span>
                            <span class="text-muted">{{ translate('dashboard.task_count_unlimited')|replace('{count}', tasks|length|string) }}</span>
                        </div>
                        {% else %}
                        <small class="text-muted">
                            {% set limit_value = task_limit if task_limit and task_limit != -1 else 3 %}
                            {{ translate('dashboard.task_count')|replace('{current}', tasks|length|string)|replace('{limit}', limit_value|string) }}
                            {% if task_limit != -1 and tasks|length >= (task_limit or 3) %}
                            <span class="status-badge pending ms-2">{{ translate('dashboard.reached_limit') }}</span>
                            {% endif %}
                        </small>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        {% if tasks %}
        <div class="row g-3">
            {% for task in tasks %}
            <div class="col-md-4 col-sm-6">
                <div class="card h-100">
                    <div class="card-header" style="padding-bottom: 0.75rem;">
                        <h5 class="card-title mb-2" style="color: white; font-weight: 600;">{{ task.title }}</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            {% if task.organization_id %}
                            <span class="badge" style="background-color: #8b5cf6; font-size: 0.75rem;">
                                <i class="bi bi-building"></i> {{ task.organization.name }}
                            </span>
                            {% else %}
                            <span class="badge" style="background-color: #93c5fd; font-size: 0.75rem;">
                                <i class="bi bi-person"></i> {{ task.author.username }}
                            </span>
                            {% endif %}
                            {% if task.sharing_type == 'organization' %}
                            <span class="badge" style="background-color: #8b5cf6; font-size: 0.75rem;">
                                <i class="bi bi-people-fill"></i> {{ translate('task_detail.organization_shared') }}
                            </span>
                            {% elif task.sharing_type == 'shared' %}
                            <span class="badge" style="background-color: #10b981; font-size: 0.75rem;">
                                <i class="bi bi-share-fill"></i> {{ translate('task_detail.shared') }}
                            </span>
                            {% else %}
                            <span class="badge" style="background-color: #93c5fd; color: #1e40af; font-size: 0.75rem;">
                                <i class="bi bi-lock-fill"></i> {{ translate('task_detail.private') }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body" style="padding-bottom: 0.25rem;">
                        {% if task.description %}
                        <p class="card-text mb-3">{{ task.description }}</p>
                        {% else %}
                        <p class="card-text mb-3 text-muted">{{ translate('dashboard.no_description') }}</p>
                        {% endif %}
                        <div class="mb-3">
                            <small class="text-muted">{{ translate('dashboard.created_at') }}: {{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">{{ translate('dashboard.submission_count') }}: {{ task.submission|length }}</small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label text-sm font-weight-bold">{{ translate('dashboard.data_url') }}:</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" readonly value="{{ request.host_url|replace('https://', 'http://') }}api/{{ task.task_id }}" id="url-{{ task.id }}">
                                <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('url-{{ task.id }}')" style="font-weight: 500; background-color: #6b7280; color: white; border: none;">
                                    <i class="bi bi-clipboard" style="margin-right: 0.375rem;"></i>{{ translate('base.copy') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer" style="background-color: #f9fafb; border-top: 1px solid #e5e7eb; padding: 1rem;">
                        <div class="d-flex justify-content-between align-items-center gap-2" style="flex-wrap: nowrap; overflow-x: auto;">
                            <a href="{{ url_for('quickform.task_detail', task_id=task.id) }}" class="btn btn-sm" style="font-weight: 500; background-color: white; color: #2563eb; border: 1px solid #2563eb; height: 36px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;">
                                <i class="bi bi-eye" style="margin-right: 0.375rem;"></i>{{ translate('dashboard.view_detail') }}
                            </a>
                            <a href="{{ url_for('quickform.export_data', task_id=task.id) }}" class="btn btn-sm" style="font-weight: 500; background-color: white; color: #10b981; border: 1px solid #10b981; height: 36px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;">
                                <i class="bi bi-download" style="margin-right: 0.375rem;"></i>{{ translate('dashboard.export') }}
                            </a>
                            <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ task.id }}" style="font-weight: 500; background-color: white; color: #ef4444; border: 1px solid #ef4444; height: 36px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;">
                                <i class="bi bi-trash" style="margin-right: 0.375rem;"></i>{{ translate('common.delete') }}
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 删除确认模态框 -->
                <div class="modal fade" id="deleteModal-{{ task.id }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLabel-{{ task.id }}">{{ translate('dashboard.confirm_delete') }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                {{ translate('dashboard.delete_confirm_message')|replace('{title}', task.title) }}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ translate('common.cancel') }}</button>
                                <form action="{{ url_for('quickform.delete_task', task_id=task.id) }}" method="POST">
                                    <button type="submit" class="btn btn-danger">{{ translate('dashboard.confirm_delete_btn') }}</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" class="bi bi-inbox" viewBox="0 0 16 16">
                        <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm-1.17-.437A1.5 1.5 0 0 1 4.98 3h6.04a1.5 1.5 0 0 1 1.17.563l3.7 4.625a.5.5 0 0 1 .106.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374L3.8 3.563zM3.8 6.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5v-6a.5.5 0 0 0-.5-.5H3.8z"/>
                    </svg>
                </div>
                <h4>{{ translate('dashboard.no_tasks') }}</h4>
                <p class="text-muted mb-4">{{ translate('dashboard.no_tasks_desc') }}</p>
                <a href="{{ url_for('quickform.create_task') }}" class="btn btn-primary">{{ translate('dashboard.create_task') }}</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
    
    {% block scripts %}
<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // 显示复制成功提示
        const btn = element.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '{{ translate("js.copy_success") }}';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    }
    
</script>
{% endblock %}
{% endblock %}