{% extends 'base.html' %}

{% block title %}{{ task.title }} - QuickForm{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between items-center mb-4">
            <h2>{{ task.title }}</h2>
            <div>
                <a href="{{ url_for('quickform.export_data', task_id=task.id) }}" class="btn btn-success me-2" style="font-weight: 500;">
                    <i class="bi bi-download"></i>{{ translate('task_detail.export_data') }}
                </a>
                <a href="{{ url_for('quickform.smart_analyze', task_id=task.id) }}" class="btn btn-info me-2" style="font-weight: 500;">
                    <i class="bi bi-bar-chart"></i>{{ translate('task_detail.analyze') }}
                </a>
                <a href="{{ url_for('quickform.edit_task', task_id=task.id) }}" class="btn btn-primary me-2" style="font-weight: 500;">
                    <i class="bi bi-pencil"></i>{{ translate('task_detail.edit_task') }}
                </a>
                <a href="{{ url_for('quickform.dashboard') }}" class="btn btn-secondary" style="font-weight: 500;">
                    <i class="bi bi-arrow-left"></i>{{ translate('task_detail.back_to_list') }}
                </a>
            </div>
        </div>
        
        <!-- ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0" style="color: white; font-weight: 600;">{{ translate('task_detail.task_info') }}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-4 mb-3 flex-wrap">
                    <p class="mb-0"><strong>{{ translate('task_detail.created_at') }}ï¼š</strong>{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    <p class="mb-0"><strong>{{ translate('task_detail.submission_count') }}ï¼š</strong>{{ total_submissions }}</p>
                    <p class="mb-0">
                        <strong>{{ translate('task_detail.task_source') }}</strong>
                        {% if task.organization_id %}
                        <span class="badge" style="background-color: #8b5cf6; color: white;">
                            <i class="bi bi-building"></i> {{ task.organization.name }}
                        </span>
                        {% else %}
                        <span class="badge" style="background-color: #2563eb; color: white;">
                            <i class="bi bi-person"></i> {{ task.author.username }}
                        </span>
                        {% endif %}
                    </p>
                    <p class="mb-0">
                        <strong>{{ translate('task_detail.sharing_status') }}</strong>
                        {% if task.sharing_type == 'organization' %}
                        <span class="badge" style="background-color: #8b5cf6; color: white;">
                            <i class="bi bi-people-fill"></i> {{ translate('task_detail.organization_shared') }}
                        </span>
                        {% elif task.sharing_type == 'shared' %}
                        <span class="badge" style="background-color: #10b981; color: white;">
                            <i class="bi bi-share-fill"></i> {{ translate('task_detail.shared') }}
                        </span>
                        {% else %}
                        <span class="badge" style="background-color: #93c5fd; color: #ffffff;">
                            <i class="bi bi-lock-fill"></i> {{ translate('task_detail.private') }}
                        </span>
                        {% endif %}
                    </p>
                </div>
                {% if task.description %}
                <div class="mt-3">
                    <strong>{{ translate('task_detail.description') }}ï¼š</strong>
                    <p>{{ task.description }}</p>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    {% if task.file_name %}
                    <div class="alert alert-success mb-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>{{ translate('task_detail.uploaded_file') }}ï¼š</strong>
                                <a href="{{ url_for('quickform.uploaded_file', filename=saved_filename) }}" target="_blank" class="text-decoration-none">
                                    {{ task.file_name }}
                                </a>
                            </div>
                            {% if task.html_approved == 1 %}
                            <div class="position-relative">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleQRCode(this)" data-url="{{ url_for('quickform.uploaded_file', filename=saved_filename, _external=True) }}" style="font-weight: 500;">
                                    <i class="bi bi-qr-code"></i>{{ translate('task_detail.show_qrcode') }}
                                </button>
                                <div class="qr-code-container" id="qr-container-{{ task.id }}" style="display: none; position: relative; z-index: 10; background: white; padding: 16px; border: 1px solid #ddd; border-radius: 8px; margin-top: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); max-width: 360px;">
                                    <div id="qrcode-{{ task.id }}" style="width: 360px; height: 360px;"></div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% if task.html_approved == -1 %}
                        <div class="alert alert-danger mt-2 mb-0" role="alert">
                            {{ translate('task_detail.review_rejected') }}{{ task.html_review_note or translate('task_detail.review_rejected') }}ã€‚
                        </div>
                        {% elif task.html_approved != 1 %}
                        <div class="alert alert-warning mt-2 mb-0" role="alert">
                            {{ translate('task_detail.review_pending') }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-2">
                        <p class="mb-0">{{ translate('task_detail.no_html_file') }} <a href="{{ url_for('quickform.edit_task', task_id=task.id) }}" class="alert-link">{{ translate('task_detail.edit_task_link') }}</a> {{ translate('task_detail.page') }}</p>
                    </div>
                    {% endif %}
                </div>

                {% if task.rate_limit_log %}
                <div class="mt-3">
                    <div class="alert alert-warning" role="alert">
                        <button class="btn btn-sm btn-outline-warning float-end" type="button" data-bs-toggle="collapse" data-bs-target="#rateLimitDetails" aria-expanded="false" style="font-weight: 500;">
                            <span class="badge bg-warning text-dark" id="rateLimitBadge">0</span> {{ translate('task_detail.rate_limit_title') }} <i class="bi bi-chevron-down"></i>
                        </button>
                        <strong>{{ translate('task_detail.rate_limit_alert') }}</strong>
                        <div class="collapse mt-2" id="rateLimitDetails">
                            <div id="rateLimitContent" class="bg-light border p-2 rounded" style="font-size: 0.9rem;"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- å…±äº«ç®¡ç†å¡ç‰‡ -->
        {% if task.user_id == current_user.id %}
        <div class="card mb-4">
            <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#shareManagement" aria-expanded="false" aria-controls="shareManagement">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" style="color: white; font-weight: 600;">
                        <i class="bi bi-share"></i> {{ translate('task_detail.share_management') }}
                    </h5>
                    <i class="bi bi-chevron-down" style="color: white; transition: transform 0.3s;" id="shareManagementIcon"></i>
                </div>
            </div>
            <div class="collapse" id="shareManagement">
                <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>{{ translate('task_detail.assign_to_org') }}</strong></label>
                        <form method="POST" action="{{ url_for('quickform.assign_task_to_org', task_id=task.id) }}" class="d-flex gap-2">
                            <select name="organization_id" class="form-select" required>
                                <option value="">{{ translate('task_detail.select_org') }}</option>
                                {% for org in user_organizations %}
                                <option value="{{ org.id }}" {% if task.organization_id == org.id %}selected{% endif %}>
                                    {{ org.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                                <i class="bi bi-check"></i> {{ translate('task_detail.assign') }}
                            </button>
                            {% if task.organization_id %}
                            <button type="button" class="btn btn-outline-secondary" onclick="removeFromOrg({{ task.id }})" style="white-space: nowrap;">
                                <i class="bi bi-x"></i> {{ translate('task_detail.remove') }}
                            </button>
                            {% endif %}
                        </form>
                        <small class="text-muted">{{ translate('task_detail.assign_hint') }}</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>{{ translate('task_detail.share_to_user') }}</strong></label>
                        <form method="POST" action="{{ url_for('quickform.share_task_to_user', task_id=task.id) }}" class="d-flex gap-2" id="shareUserForm">
                            <input type="text" name="username" class="form-control" placeholder="{{ translate('task_detail.enter_username') }}" required>
                            <button type="submit" class="btn btn-success" style="white-space: nowrap;">
                                <i class="bi bi-person-plus"></i> {{ translate('task_detail.add') }}
                            </button>
                        </form>
                        <small class="text-muted">{{ translate('task_detail.share_hint') }}</small>
                    </div>
                </div>
                
                {% if shared_users and shared_users|length > 0 %}
                <div class="mt-3">
                    <strong class="d-block mb-2">{{ translate('task_detail.shared_to') }}</strong>
                    <div class="d-flex flex-wrap gap-2">
                        {% for share in shared_users %}
                        <div class="badge" style="background-color: #e0e7ff; color: #3730a3; font-size: 0.9rem; padding: 0.5rem 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-person"></i>
                            {{ share.user.username }}
                            <button type="button" class="btn-close btn-close-sm" onclick="removeShare({{ share.id }})" style="font-size: 0.6rem; margin-left: 0.25rem;"></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- POSTæŒ‡ä»¤æç¤ºè¯å¡ç‰‡ -->
        <div class="card mb-4">
            <div class="card-header ">
                <h5 class="mb-0" style="color: white; font-weight: 600;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-code-square" viewBox="0 0 16 16" style="margin-right: 8px;">
                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0zm2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0z"/>
                    </svg>
                    {{ translate('task_detail.post_prompt_title') }}
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">{{ translate('task_detail.post_instruction') }}</p>
                
                <!-- URLæ˜¾ç¤º -->
                <div class="mb-3">
                    <label class="form-label"><strong>{{ translate('task_detail.data_url_label') }}</strong></label>
                    <div class="input-group">
                        <input type="text" class="form-control" readonly value="{{ request.host_url|replace('https://', 'http://') }}api/{{ task.task_id }}" id="post-url">
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('post-url')" style="font-weight: 500;">
                            <i class="bi bi-clipboard"></i>{{ translate('task_detail.copy_url') }}
                        </button>
                    </div>
                </div>
                
                <!-- æç¤ºè¯æ¨¡æ¿ -->
                <div class="mb-3">
                    <label class="form-label"><strong>{{ translate('task_detail.simple_prompt_label') }}</strong></label>
                    <div class="input-group">
                        <textarea class="form-control" id="simple-prompt-text" rows="3" readonly style="font-family: 'Courier New', monospace; font-size: 13px;">{{ translate('task_detail.simple_prompt_text') }} '{{ request.host_url|replace('https://', 'http://') }}api/{{ task.task_id }}' {{ translate('task_detail.simple_prompt_send') }}</textarea>
                        <button class="btn btn-outline-primary" onclick="copyToClipboardText('simple-prompt-text')" style="font-weight: 500;">
                            <i class="bi bi-clipboard"></i>{{ translate('task_detail.copy') }}
                        </button>
                    </div>
                </div>
                
                <!-- GETæ–¹æ³•è¯´æ˜ -->
                <div class="alert alert-info mb-3">
                    <strong>ğŸ’¡</strong> {{ translate('task_detail.data_query_tip') }}
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0"><strong>{{ translate('task_detail.full_prompt_label') }}</strong></label>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#fullPromptCollapse" aria-expanded="false" style="font-weight: 500;">{{ translate('task_detail.expand_collapse') }}</button>
                    </div>
                    <div class="collapse" id="fullPromptCollapse">
                        <div class="input-group">
                            <textarea class="form-control" id="prompt-text" rows="15" readonly style="font-family: 'Courier New', monospace; font-size: 13px;">{{ translate('dashboard.code_example_comment') }}

<script>
function sendTestData() {
    const url = '{{ request.host_url|replace('https://', 'http://') }}api/{{ task.task_id }}';
    const data = {"{{ translate('dashboard.code_example_field') }}1": "{{ translate('dashboard.code_example_value') }}1", "{{ translate('dashboard.code_example_field') }}2": "{{ translate('dashboard.code_example_value') }}2"};
    document.getElementById('send-result').textContent = "{{ translate('dashboard.code_example_submitting') }}";
    fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)})
    .then(async r => {
        const text = await r.text();
        let json = {};
        try { json = JSON.parse(text); } catch(e) { json = {raw: text}; }
        if (!r.ok) throw new Error(json.error || json.message || `HTTP ${r.status}`);
        return json;
    })
    .then(d => {
        document.getElementById('send-result').textContent = "{{ translate('dashboard.code_example_success') }}: " + JSON.stringify(d);
        document.getElementById('send-result').style.color = '#28a745';
        console.log('{{ translate('dashboard.code_example_success') }}:', d);
    })
    .catch(e => {
        document.getElementById('send-result').textContent = "{{ translate('dashboard.code_example_failed') }}: " + e.message;
        document.getElementById('send-result').style.color = '#dc3545';
        console.error('{{ translate('dashboard.code_example_failed') }}:', e, 'URL:', url, 'Data:', data);
    });
}
</script></textarea>
                            <button class="btn btn-primary" onclick="copyToClipboardText('prompt-text')" style="font-weight: 500;">
                                <i class="bi bi-clipboard-check"></i>{{ translate('dashboard.copy_prompt') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æäº¤æ•°æ®åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" style="color: white; font-weight: 600;">{{ translate('task_detail.submission_list') }}</h5>
                {% if submissions %}
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteAllData()">ğŸ—‘ {{ translate('task_detail.delete_all') }}</button>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- æµ‹è¯•æ•°æ®æäº¤åŒºåŸŸ -->
                <div class="mb-4 p-3 border rounded" style="background-color: #f0f7ff; border-color: #4a90e2;">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-code-square me-2" style="font-size: 1.5rem; color: #4a90e2;"></i>
                        <h5 class="mb-0" style="font-weight: 600; color: #2563eb;">
                            {{ translate('task_detail.debug_test') }}
                        </h5>
                    </div>
                    <p class="text-muted mb-3">{{ translate('task_detail.debug_test_desc') }}</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">{{ translate('task_detail.data_content') }}</label>
                        <textarea 
                            id="test-data-input" 
                            class="form-control" 
                            rows="6" 
                            placeholder="{{ translate('task_detail.debug_input_placeholder') }}"
                            style="font-family: 'Courier New', monospace; font-size: 13px; border: 2px solid #e0e7ff;"></textarea>
                        <small class="text-muted d-block mt-1">{{ translate('task_detail.debug_test_desc') }}</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            onclick="submitTestData()"
                            id="test-submit-btn"
                            style="font-weight: 500;">
                            <i class="bi bi-send-fill"></i> {{ translate('task_detail.debug_submit') }}
                        </button>
                        <span id="test-submit-status" class="small ms-2"></span>
                    </div>
                </div>
                
                {% if submissions %}
                <div class="overflow-auto">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>{{ translate('task_detail.submission_time') }}</th>
                                <th>{{ translate('task_detail.data_content') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in submissions %}
                            <tr>
                                <td>{{ sub.id }}</td>
                                <td>{{ sub.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button 
                                            type="button" 
                                            class="btn btn-link p-0"
                                            data-sub-id="{{ sub.id }}"
                                            data-sub-time="{{ sub.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}"
                                            data-sub-data='{{ sub.data | tojson | safe }}'
                                            onclick="openDataModal(this);">
                                            {{ translate('task_detail.view_data') }}
                                        </button>
                                        <button 
                                            type="button" 
                                            class="btn btn-sm btn-danger"
                                            onclick="deleteSingleData({{ sub.id }})">
                                            ğŸ—‘ {{ translate('task_detail.delete') }}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div class="mt-4">
                    <p class="text-center mb-2">{{ translate('task_detail.total_records')|replace('{count}', total_submissions|string) }}</p>
                    {% if pagination.pages > 1 %}
                    {% set page_links = pagination.links if pagination.links is defined else range(1, pagination.pages + 1) %}
                    <nav aria-label="{{ translate('task_detail.pagination') }}">
                        <ul class="pagination justify-content-center">
                            <li class="page-item {% if pagination.page <= 1 %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('quickform.task_detail', task_id=task.id, page=pagination.page - 1, per_page=pagination.per_page) }}" aria-label="{{ translate('task_detail.prev_page_aria') }}">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% for p in page_links %}
                                {% if p == '...' or p == 'ellipsis' %}
                                <li class="page-item disabled"><span class="page-link">â€¦</span></li>
                                {% else %}
                                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('quickform.task_detail', task_id=task.id, page=p, per_page=pagination.per_page) }}">{{ p }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            <li class="page-item {% if pagination.page >= pagination.pages %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('quickform.task_detail', task_id=task.id, page=pagination.page + 1, per_page=pagination.per_page) }}" aria-label="{{ translate('task_detail.next_page') }}">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" class="bi bi-database" viewBox="0 0 16 16">
                            <path d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                            <path d="M6.5 16a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1H6.5v1zm-2-1a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-1H4.5v1z"/>
                        </svg>
                    </div>
                    <h4>{{ translate('task_detail.no_submissions') }}</h4>
                    <p class="text-muted mb-4">{{ translate('task_detail.no_submissions_desc') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/qrcode.min.js') }}"></script>
<script>
    // æ‹–æ‹½ä¸Šä¼ å¤„ç†å‡½æ•°
    function toggleQRCode(btn) {
        const container = btn.nextElementSibling;
        const qrcodeDiv = container.querySelector('div[id^="qrcode-"]');
        const url = btn.getAttribute('data-url');
        
        if (container.style.display === 'none' || container.style.display === '') {
            container.style.display = 'block';
            // å¦‚æœäºŒç»´ç è¿˜æ²¡æœ‰ç”Ÿæˆï¼Œåˆ™ç”Ÿæˆå®ƒ
            if (qrcodeDiv && !qrcodeDiv.hasAttribute('data-generated')) {
                try {
                    // æ¸…ç©ºdivå†…å®¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    qrcodeDiv.innerHTML = '';
                    // ä½¿ç”¨æ›´å¤§çš„å°ºå¯¸ç”ŸæˆäºŒç»´ç 
                    new QRCode(qrcodeDiv, {
                        text: url,
                        width: 360,
                        height: 360,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    qrcodeDiv.setAttribute('data-generated', 'true');
                } catch (error) {
                    console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                    alert('{{ translate("task_detail.qrcode_error") }}');
                    container.style.display = 'none';
                }
            }
        } else {
            container.style.display = 'none';
        }
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­äºŒç»´ç 
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.qr-code-container') && !e.target.closest('button[onclick*="toggleQRCode"]')) {
            document.querySelectorAll('.qr-code-container').forEach(function(container) {
                container.style.display = 'none';
            });
        }
    });
    
    // å¤„ç†å°ç¦é€šçŸ¥æ˜¾ç¤º
    (function processRateLimitLog() {
        const rateLimitLog = {{ task.rate_limit_log | tojson if task.rate_limit_log else 'null' }};
        if (!rateLimitLog) return;
        
        const lines = rateLimitLog.split('\n').filter(l => l.trim());
        const ipGroups = {};
        const now = Math.floor(Date.now() / 1000);
        const blacklistDuration = 600; // 10åˆ†é’Ÿ
        
        lines.forEach(function(line) {
            const match = line.match(/\[([^\]]+)\]\s*IP\s+([^\s]+)\s+åœ¨\s+(\d+)s\s+å†…å¤šæ¬¡æäº¤ï¼Œå·²æš‚æ—¶å°ç¦\s+(\d+)\s+åˆ†é’Ÿ/);
            if (match) {
                const timestamp = match[1];
                const ip = match[2];
                const windowSeconds = parseInt(match[3]);
                const banMinutes = parseInt(match[4]);
                
                // è§£ææ—¶é—´æˆ³
                const timeMatch = timestamp.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/);
                if (timeMatch) {
                    const banTime = new Date(timestamp);
                    const banTimestamp = Math.floor(banTime.getTime() / 1000);
                    const expireTimestamp = banTimestamp + (banMinutes * 60);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
                    if (expireTimestamp > now) {
                        if (!ipGroups[ip]) {
                            ipGroups[ip] = [];
                        }
                        ipGroups[ip].push({
                            timestamp: timestamp,
                            windowSeconds: windowSeconds,
                            banMinutes: banMinutes,
                            expireTimestamp: expireTimestamp
                        });
                    }
                }
            }
        });
        
        const container = document.getElementById('rateLimitContent');
        const badge = document.getElementById('rateLimitBadge');
        if (!container) return;
        
        const activeCount = Object.keys(ipGroups).length;
        if (badge) badge.textContent = activeCount;
        
        if (activeCount === 0) {
            container.innerHTML = '<p class="text-muted mb-0">{{ translate("task_detail.no_active_blocks") }}</p>';
            return;
        }
        
        let html = '';
        Object.keys(ipGroups).forEach(function(ip) {
            const records = ipGroups[ip];
            const latest = records[records.length - 1];
            const remainingSeconds = latest.expireTimestamp - now;
            const remainingMinutes = Math.ceil(remainingSeconds / 60);
            
            html += '<div class="mb-2 p-2 border rounded">';
            html += '<strong>IP: ' + ip + '</strong><br>';
            html += '<small class="text-muted">{{ translate("task_detail.block_time") }}' + latest.timestamp + '</small><br>';
            html += '<small class="text-danger">{{ translate("task_detail.remaining_time") }}' + remainingMinutes + '{{ translate("task_detail.remaining_minutes") }}</small>';
            if (records.length > 1) {
                html += '<br><small class="text-muted">{{ translate("task_detail.block_records_count") }}' + records.length + '{{ translate("task_detail.block_records_suffix") }}</small>';
            }
            html += '</div>';
        });
        
        container.innerHTML = html;
        
        // è®¾ç½®å®šæ—¶å™¨ï¼Œè‡ªåŠ¨æ›´æ–°å‰©ä½™æ—¶é—´
        setInterval(function() {
            const now = Math.floor(Date.now() / 1000);
            const newIpGroups = {};
            Object.keys(ipGroups).forEach(function(ip) {
                const records = ipGroups[ip];
                const latest = records[records.length - 1];
                if (latest.expireTimestamp > now) {
                    newIpGroups[ip] = records;
                }
            });
            
            if (Object.keys(newIpGroups).length !== Object.keys(ipGroups).length) {
                // æœ‰è®°å½•è¿‡æœŸï¼Œé‡æ–°æ¸²æŸ“
                processRateLimitLog();
            } else {
                // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
                const container = document.getElementById('rateLimitContent');
                if (container) {
                    let html = '';
                    Object.keys(ipGroups).forEach(function(ip) {
                        const records = ipGroups[ip];
                        const latest = records[records.length - 1];
                        const remainingSeconds = latest.expireTimestamp - now;
                        const remainingMinutes = Math.ceil(remainingSeconds / 60);
                        
                        html += '<div class="mb-2 p-2 border rounded">';
                        html += '<strong>IP: ' + ip + '</strong><br>';
                        html += '<small class="text-muted">{{ translate("task_detail.block_time") }}' + latest.timestamp + '</small><br>';
                        html += '<small class="text-danger">{{ translate("task_detail.remaining_time") }}' + remainingMinutes + '{{ translate("task_detail.remaining_minutes") }}</small>';
                        if (records.length > 1) {
                            html += '<br><small class="text-muted">{{ translate("task_detail.block_records_count") }}' + records.length + '{{ translate("task_detail.block_records_suffix") }}</small>';
                        }
                        html += '</div>';
                    });
                    container.innerHTML = html;
                }
            }
        }, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    })();
    
    window.copyToClipboard = function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const btn = element.nextElementSibling;
        if (!btn) return;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> å·²å¤åˆ¶';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    };
    
    window.copyToClipboardText = function copyToClipboardText(containerId) {
        const container = document.getElementById(containerId);
        let textarea = null;
        let button = null;

        if (container) {
            if (container.tagName && container.tagName.toLowerCase() === 'textarea') {
                textarea = container;
                button = container.nextElementSibling;
            } else {
                textarea = container.querySelector('textarea');
                button = container.querySelector('button');
            }
        } else {
            const element = document.getElementById(containerId);
            if (element && element.tagName && element.tagName.toLowerCase() === 'textarea') {
                textarea = element;
                button = element.nextElementSibling;
            }
        }

        if (!textarea) return;
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const btn = button || (container ? container.querySelector('.btn-primary, .btn-success, .btn-outline-primary, .btn-outline-secondary') : null);
        if (!btn) return;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 2.3 6.896a.235.235 0 0 0-.307.01l-.89.89a.5.5 0 0 0 .696.697l1.656-1.656a.235.235 0 0 0 .022-.023l3.473-4.425a.5.5 0 0 1 .703-.03l3.5 3.5a.5.5 0 0 1 .03.703z"/></svg> å·²å¤åˆ¶';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
    };

    // å•ä¸€å…¨å±€æ¨¡æ€æ¡†ï¼Œé¿å…æ»šåŠ¨æ—¶å‡ºç°å¤šä¸ªæ‚¬æµ®çª—
    (function ensureSingleModal(){
        if (document.getElementById('singleDataModal')) return;
        const modalWrap = document.createElement('div');
        modalWrap.id = 'singleDataModal';
        modalWrap.style.cssText = 'display:none; position:fixed; inset:0; z-index:1050;';
        modalWrap.innerHTML = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.2);"></div>
            <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); margin:0; display:flex; align-items:center; justify-content:center;">
                <div class="modal-content" style="width:90%; height:90%; max-height:500px; max-width:900px; display:flex; flex-direction:column; background:white; margin:0; padding:0;">
                    <div class="modal-header" style="padding:10px 15px; border-bottom:1px solid #dee2e6; margin:0;">
                        <h5 id="singleDataModalTitle" class="modal-title" style="margin:0; font-size:16px;">{{ translate('task_detail.modal_title') }}</h5>
                        <button type="button" class="btn" style="border:none; background:transparent; font-size:20px;" onclick="window.hideDataModal()" aria-label="{{ translate('common.close') }}">âœ–</button>
                    </div>
                    <div class="modal-body" style="padding:15px; flex-grow:1; overflow-y:auto; margin:0;">
                        <p style="margin:0 0 10px 0; font-size:14px;"><strong>{{ translate('task_detail.modal_submission_time') }}</strong><span id="singleDataModalTime"></span></p>
                        <div style="margin:0;">
                            <h6 style="margin:0 0 8px 0; font-size:14px;">{{ translate('task_detail.modal_data_content') }}</h6>
                            <pre id="singleDataModalContent" class="bg-light p-3 rounded overflow-auto" style="font-size:16px; line-height:1.6; white-space:pre-wrap; word-wrap:break-word; margin:0; min-height:300px;"></pre>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding:10px 15px; border-top:1px solid #dee2e6; justify-content:flex-end; margin:0;">
                        <button type="button" class="btn btn-secondary" onclick="window.hideDataModal()">{{ translate('task_detail.modal_close') }}</button>
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modalWrap);
        // ç‚¹å‡»é®ç½©å…³é—­
        modalWrap.firstElementChild.addEventListener('click', window.hideDataModal);
    })();

    window.openDataModal = function openDataModal(btn){
        const wrap = document.getElementById('singleDataModal');
        if (!wrap) return;
        const id = btn.getAttribute('data-sub-id') || '';
        const t = btn.getAttribute('data-sub-time') || '';
        let d = btn.getAttribute('data-sub-data') || '';
        try { d = JSON.stringify(JSON.parse(d), null, 2); } catch(e) {}
        document.getElementById('singleDataModalTitle').textContent = '{{ translate("task_detail.modal_title_prefix") }}' + id;
        document.getElementById('singleDataModalTime').textContent = t;
        document.getElementById('singleDataModalContent').textContent = d;
        wrap.style.display = 'block';
    };
    window.hideDataModal = function hideDataModal(){
        const wrap = document.getElementById('singleDataModal');
        if (wrap) wrap.style.display = 'none';
    };

    // åˆ é™¤å•æ¡æ•°æ®
    window.deleteSingleData = function deleteSingleData(subId) {
        if (!confirm('{{ translate("task_detail.confirm_delete_single") }}')) {
            return;
        }
        
        const baseUrl = `{{ url_for('quickform.remove_submission', task_id=task.id) }}?submission_id=${subId}`;
        const url = baseUrl + `&_=${Date.now()}`;
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            cache: 'no-store'
        })
        .then(async response => {
            const text = await response.text();
            let data = {};
            try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { message: text }; }
            if (!response.ok) {
                throw new Error(data.message || data.error || `HTTP ${response.status}`);
            }
            return data;
        })
        .then(data => {
            if (data.success) {
                alert('{{ translate("task_detail.delete_success") }}');
                location.reload();
            } else {
                alert('{{ translate("task_detail.delete_failed") }}' + (data.message || '{{ translate("task_detail.unknown_error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ translate("task_detail.delete_failed") }}' + error.message);
        });
    };
    
    // åˆ é™¤å…¨éƒ¨æ•°æ®
    window.deleteAllData = function deleteAllData() {
        if (!confirm('{{ translate("task_detail.confirm_delete_all") }}')) {
            return;
        }
        
        const baseUrl = `{{ url_for('quickform.clear_all_submissions', task_id=task.id) }}`;
        const url = baseUrl + `?_=${Date.now()}`;
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            cache: 'no-store'
        })
        .then(async response => {
            const text = await response.text();
            let data = {};
            try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { message: text }; }
            if (!response.ok) {
                throw new Error(data.message || data.error || `HTTP ${response.status}`);
            }
            return data;
        })
        .then(data => {
            if (data.success) {
                alert('{{ translate("task_detail.delete_success") }}');
                location.reload();
            } else {
                alert('{{ translate("task_detail.delete_failed") }}' + (data.message || '{{ translate("task_detail.unknown_error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ translate("task_detail.delete_failed") }}' + error.message);
        });
    };
    
    // ç§»é™¤ç»„ç»‡åˆ†é…
    window.removeFromOrg = function removeFromOrg(taskId) {
        if (!confirm('{{ translate("task_detail.confirm_remove_org") }}')) {
            return;
        }
        
        fetch(`/task/${taskId}/remove-from-org`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ translate("task_detail.removed_from_org") }}');
                location.reload();
            } else {
                alert('{{ translate("task_detail.operation_failed") }}' + (data.message || '{{ translate("task_detail.unknown_error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ translate("task_detail.operation_failed") }}{{ translate("task_detail.network_error") }}');
        });
    };
    
    // ç§»é™¤ä¸ªäººå…±äº«
    window.removeShare = function removeShare(shareId) {
        if (!confirm('{{ translate("task_detail.confirm_remove_share") }}')) {
            return;
        }
        
        fetch(`/task/share/${shareId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{{ translate("task_detail.share_removed") }}');
                location.reload();
            } else {
                alert('{{ translate("task_detail.operation_failed") }}' + (data.message || '{{ translate("task_detail.unknown_error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ translate("task_detail.operation_failed") }}{{ translate("task_detail.network_error") }}');
        });
    };
    
    // å…±äº«ç®¡ç†æŠ˜å é¢æ¿å›¾æ ‡æ—‹è½¬
    const shareManagement = document.getElementById('shareManagement');
    const shareManagementIcon = document.getElementById('shareManagementIcon');
    
    if (shareManagement && shareManagementIcon) {
        shareManagement.addEventListener('show.bs.collapse', function () {
            shareManagementIcon.style.transform = 'rotate(180deg)';
        });
        
        shareManagement.addEventListener('hide.bs.collapse', function () {
            shareManagementIcon.style.transform = 'rotate(0deg)';
        });
    }
    
    // æµ‹è¯•æ•°æ®æäº¤åŠŸèƒ½
    window.submitTestData = function submitTestData() {
        const input = document.getElementById('test-data-input');
        const btn = document.getElementById('test-submit-btn');
        const status = document.getElementById('test-submit-status');
        
        if (!input || !btn || !status) return;
        
        const dataText = input.value.trim();
        if (!dataText) {
            status.textContent = '{{ translate("task_detail.debug_invalid_json") }}';
            status.style.color = '#dc3545';
            return;
        }
        
        // éªŒè¯JSONæ ¼å¼
        let data;
        try {
            data = JSON.parse(dataText);
        } catch (e) {
            status.textContent = '{{ translate("task_detail.debug_invalid_json") }}: ' + e.message;
            status.style.color = '#dc3545';
            return;
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºæäº¤ä¸­
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> {{ translate("task_detail.debug_submitting") }}';
        status.textContent = '';
        
        // è·å–API URL
        const apiUrl = '{{ request.host_url|replace("https://", "http://") }}api/{{ task.task_id }}';
        
        // æäº¤æ•°æ®
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(async response => {
            const text = await response.text();
            let result = {};
            try {
                result = text ? JSON.parse(text) : {};
            } catch (e) {
                result = { raw: text };
            }
            
            if (!response.ok) {
                throw new Error(result.error || result.message || `HTTP ${response.status}`);
            }
            return result;
        })
        .then(result => {
            status.textContent = '{{ translate("task_detail.debug_success") }}';
            status.style.color = '#28a745';
            input.value = '';
            
            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            status.textContent = '{{ translate("task_detail.debug_failed") }}' + error.message;
            status.style.color = '#dc3545';
            console.error('æäº¤å¤±è´¥:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-send"></i> {{ translate("task_detail.debug_submit") }}';
        });
    };
</script>
{% endblock %}
{% endblock %}