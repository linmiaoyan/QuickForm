{% extends 'base.html' %}

{% block title %}{{ translate('register.title') }} - QuickForm{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="text-center mb-0">{{ translate('register.header') }}</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('quickform.register') }}" id="registerForm">
                    <div class="mb-4">
                        <label for="username" class="form-label">{{ translate('register.username') }} <span class="text-danger">{{ translate('register.required') }}</span></label>
                        <input type="text" class="form-control" id="username" name="username" required placeholder="{{ translate('register.username_placeholder') }}" minlength="3" maxlength="20">
                    </div>
                    <div class="mb-4">
                        <label for="email" class="form-label">{{ translate('register.email') }} <span class="text-danger">{{ translate('register.required') }}</span></label>
                        <div class="input-group">
                            <input type="email" class="form-control" id="email" name="email" required placeholder="{{ translate('register.email_placeholder') }}">
                            <button type="button" class="btn btn-outline-primary" id="sendEmailCodeBtn" onclick="sendEmailCode()">
                                发送验证码
                            </button>
                        </div>
                        <small class="form-text text-muted">请填写可用邮箱，用于接收验证码。</small>
                    </div>
                    <div class="mb-4">
                        <label for="school" class="form-label">{{ translate('register.school') }} <span class="text-danger">{{ translate('register.required') }}</span></label>
                        <input type="text" class="form-control" id="school" name="school" required placeholder="{{ translate('register.school_placeholder') }}">
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="form-label">{{ translate('register.phone') }} <span class="text-danger">{{ translate('register.required') }}</span></label>
                        <input type="tel" class="form-control" id="phone" name="phone" required placeholder="{{ translate('register.phone_placeholder') }}" pattern="1[3-9][0-9]{9}" maxlength="11" minlength="11">
                        <small class="form-text text-muted">{{ translate('register.phone_hint') }}</small>
                    </div>
                    <div class="mb-4">
                        <label for="email_code" class="form-label">邮箱验证码 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="email_code" name="email_code" required placeholder="请输入邮箱验证码" maxlength="6">
                    </div>
                    <div class="mb-4">
                        <label for="password" class="form-label">{{ translate('register.password') }} <span class="text-danger">{{ translate('register.required') }}</span></label>
                        <input type="password" class="form-control" id="password" name="password" required placeholder="{{ translate('register.password_placeholder') }}" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">{{ translate('register.submit') }}</button>
                </form>
                <div class="mt-4 text-center">
                    <p>{{ translate('register.has_account') }}<a href="{{ url_for('quickform.login') }}">{{ translate('register.login_link') }}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let emailCooldown = 0;
    let emailCooldownTimer = null;

    function startEmailCooldown(btn) {
        emailCooldown = 60;
        const originalText = btn.dataset.originalText || btn.textContent;
        btn.dataset.originalText = originalText;
        btn.disabled = true;

        function tick() {
            if (emailCooldown <= 0) {
                btn.disabled = false;
                btn.textContent = btn.dataset.originalText || '发送验证码';
                emailCooldownTimer = null;
                return;
            }
            btn.textContent = '重新发送(' + emailCooldown + 's)';
            emailCooldown--;
            emailCooldownTimer = setTimeout(tick, 1000);
        }

        tick();
    }

    async function sendEmailCode() {
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        const btn = document.getElementById('sendEmailCodeBtn');

        if (emailCooldown > 0) {
            return;
        }

        if (!email) {
            alert('请先填写邮箱地址');
            return;
        }

        btn.disabled = true;
        btn.textContent = '发送中...';

        try {
            const resp = await fetch('/api/email/send_code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email })
            });
            const data = await resp.json();
            if (data.success) {
                alert('验证码已发送到邮箱，请在10分钟内完成验证');
                startEmailCooldown(btn);
            } else {
                alert(data.message || '发送失败');
                btn.disabled = false;
                btn.textContent = '发送验证码';
            }
        } catch (e) {
            alert('请求失败：' + e.message);
            btn.disabled = false;
            btn.textContent = '发送验证码';
        }
    }
</script>
{% endblock %}