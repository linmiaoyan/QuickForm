{% extends 'base.html' %}

{% block title %}{{ translate('task_detail.edit_task') }} - QuickForm{% endblock %}

{% block content %}
<style>
.edit-task-header {
    background: #2563eb;
    color: white;
    padding: 1rem 2rem;
    margin: -1.5rem -15px 2rem -15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.edit-task-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
}

.task-id-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.status-badge-selectable {
    display: inline-flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.status-option {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
    font-size: 0.875rem;
}

.status-option:hover {
    border-color: #2563eb;
    color: #2563eb;
}

.status-option.active {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

.status-option.running.active {
    background: #3b82f6;
    border-color: #3b82f6;
}

.status-option.pending.active {
    background: #f59e0b;
    border-color: #f59e0b;
}

.edit-content-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

@media (max-width: 992px) {
    .edit-content-layout {
        grid-template-columns: 1fr;
    }
}

.recent-changes {
    list-style: none;
    padding: 0;
}

.recent-changes li {
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
    color: #6b7280;
    font-size: 0.875rem;
}

.recent-changes li:last-child {
    border-bottom: none;
}
</style>

<!-- 顶部导航栏 -->
<div class="edit-task-header">
    <div>
        <h2>{{ translate('task_detail.edit_task') }}</h2>
        <div class="task-id-badge">
            <span>{{ task.title }} - {{ translate('edit_task.task_id') }}:</span>
            <input type="text" value="{{ task.task_id }}" readonly style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 4px; padding: 0.25rem 0.5rem; width: 100px; font-size: 0.9rem;">
        </div>
    </div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        {% if current_user.is_admin() %}
        <a href="{{ url_for('quickform.admin_panel') }}" class="btn btn-light btn-sm" style="font-weight: 500;">{{ translate('nav.admin_panel') }}</a>
        {% endif %}
        <a href="{{ url_for('quickform.index') }}" class="btn btn-light btn-sm" style="font-weight: 500;">{{ translate('nav.home') }}</a>
        <a href="{{ url_for('quickform.logout') }}" class="btn btn-light btn-sm" style="font-weight: 500;">{{ translate('nav.logout') }}</a>
    </div>
</div>

<div class="edit-content-layout">
    <!-- 左侧：表单内容 -->
    <div>
        <form id="edit-task-form" method="POST" action="{{ url_for('quickform.edit_task', task_id=task.id) }}" enctype="multipart/form-data">
            <!-- 基础信息卡片 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0" style="color: white; font-weight: 600;">{{ translate('edit_task.basic_info') }}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label for="title" class="form-label">{{ translate('create_task.task_title') }}</label>
                        <input type="text" class="form-control" id="title" name="title" required value="{{ task.title }}">
                    </div>
                    <div class="mb-4">
                        <label for="description" class="form-label">{{ translate('create_task.description') }}</label>
                        <textarea class="form-control" id="description" name="description" rows="4" placeholder="{{ translate('create_task.description_placeholder') }}">{{ task.description }}</textarea>
                    </div>
                    
                    <!-- 状态选择 -->
                    <div class="mb-3">
                        <label class="form-label">{{ translate('edit_task.status') }}</label>
                        <div class="status-badge-selectable">
                            <input type="radio" name="status" value="running" id="status-running" class="d-none" checked>
                            <label for="status-running" class="status-option running active">{{ translate('edit_task.status_running') }}</label>
                            <input type="radio" name="status" value="pending" id="status-pending" class="d-none">
                            <label for="status-pending" class="status-option pending">{{ translate('edit_task.status_pending') }}</label>
                        </div>
                    </div>
                    
                    <!-- 可见性选择 -->
                    <div class="mb-3">
                        <label class="form-label">{{ translate('edit_task.visibility') }}</label>
                        <select class="form-select" name="visibility">
                            <option value="private" selected>{{ translate('edit_task.visibility_private') }}</option>
                            <option value="public">{{ translate('edit_task.visibility_public') }}</option>
                        </select>
                    </div>
                </div>
            </div>
                    <!-- HTML文件上传卡片 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0" style="color: white; font-weight: 600;">{{ translate('edit_task.html_upload') }}</h5>
                        </div>
                        <div class="card-body">
                            <!-- 已上传文件列表 -->
                            {% if html_files and html_files|length > 0 %}
                            <div class="mb-3">
                                <label class="form-label"><strong>{{ translate('edit_task.uploaded_files') }}</strong></label>
                                <div class="d-flex flex-column gap-2" id="uploaded-files-list">
                                    {% for file in html_files %}
                                    <div class="alert alert-success mb-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-file-earmark-code"></i>
                                            <a href="{{ url_for('quickform.uploaded_file', filename=file.saved_name) }}" target="_blank" style="color: #10b981; text-decoration: underline; margin-left: 0.5rem;">
                                                {{ file.original_name }}
                                            </a>
                                        </div>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeHtmlFile('{{ file.saved_name }}'); return false;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="files_to_remove" name="files_to_remove" value="">
                            </div>
                            {% endif %}
                            
                            <!-- 拖拽上传区域 -->
                            <div id="html-upload-area-edit" class="html-upload-area" 
                                 style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 30px; text-align: center; background-color: #f9fafb; cursor: pointer; transition: all 0.3s; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;"
                                 ondrop="handleDropEdit(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeaveEdit(event)"
                                 onclick="document.getElementById('html-file-input-edit').click()">
                                <input type="file" id="html-file-input-edit" name="files" accept=".html,.htm" multiple style="display: none;" onchange="handleFileSelectEdit(event)">
                                <div id="upload-text-edit">
                                    <p class="mb-2" style="color: #6b7280; font-weight: 500; margin: 0;">{{ translate('edit_task.drag_drop') }}</p>
                                    <p class="mb-3" style="color: #9ca3af; font-size: 0.875rem; margin: 0;">{{ translate('edit_task.click_select') }}</p>
                                    <button type="button" class="btn btn-primary btn-sm">{{ translate('edit_task.select_file') }}</button>
                                </div>
                                <div id="selected-files-preview" style="display: none; width: 100%;">
                                    <p class="mb-2" style="color: #10b981; font-weight: 500;">✓ {{ translate('edit_task.selected_files') }}</p>
                                    <ul id="selected-files-list" class="list-unstyled mb-0 text-start" style="font-size: 0.9rem; color: #6b7280;"></ul>
                                </div>
                            </div>
                            <small class="form-text text-muted d-block mt-2" style="color: #9ca3af;">
                                <i class="bi bi-info-circle"></i> {{ translate('edit_task.upload_hint') }}
                            </small>
                        </div>
                    </div>
                    
                    <!-- 底部操作按钮 -->
                    <div class="d-flex justify-content-end gap-2" style="position: sticky; bottom: 1rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); margin-top: 1rem;">
                        <a href="{{ url_for('quickform.task_detail', task_id=task.id) }}" class="btn btn-outline-primary">{{ translate('common.cancel') }}</a>
                        <button type="submit" id="submit-btn" class="btn btn-primary">{{ translate('common.save') }}</button>
                    </div>
                </form>
            </div>
            
            <!-- 右侧：提示与预览 -->
            <div>
                <div class="card mb-4" style="position: sticky; top: 1rem;">
                    <div class="card-header">
                        <h5 class="mb-0" style="color: white; font-weight: 600;">{{ translate('edit_task.tips_preview') }}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-4" style="color: #111827; line-height: 1.8;">
                            <li class="mb-2">• {{ translate('edit_task.url_auto_update') }}</li>
                            <li class="mb-2">• {{ translate('edit_task.view_report') }}</li>
                            <li class="mb-2">• {{ translate('edit_task.title_hint') }}</li>
                        </ul>
                        
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #111827;">{{ translate('edit_task.submit_url_example') }}</label>
                            <div class="input-group">
                                <input type="text" class="form-control" readonly value="{{ request.host_url|replace('https://', 'http://') }}api/{{ task.task_id }}" style="background: #f9fafb; font-size: 0.875rem;">
                            </div>
                            <small class="text-muted" style="color: #9ca3af; font-size: 0.75rem;">{{ translate('edit_task.copy_hint') }}</small>
                        </div>
                        
                        <div>
                            <label class="form-label" style="font-weight: 600; color: #111827;">{{ translate('edit_task.recent_changes') }}</label>
                            <ul class="recent-changes">
                                <li>
                                    <div style="color: #111827; font-weight: 500;">2024-01-15 14:30</div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">{{ translate('edit_task.update_description') }}</div>
                                </li>
                                <li>
                                    <div style="color: #111827; font-weight: 500;">2024-01-14 10:20</div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">{{ translate('edit_task.reupload_html') }}</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // 状态选择器交互
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
            // 移除所有活动状态
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('active');
            });
            // 添加当前活动状态
            this.classList.add('active');
            // 更新对应的radio按钮
            const radio = document.getElementById(this.getAttribute('for'));
            if (radio) {
                radio.checked = true;
            }
        });
    });
    
    // 记录要删除的文件
    const filesToRemove = [];
    
    // 删除单个HTML文件
    window.removeHtmlFile = function(savedName) {
        if (!confirm('{{ translate("js.delete_file_confirm") }}')) {
            return;
        }
        
        // 添加到删除列表
        filesToRemove.push(savedName);
        document.getElementById('files_to_remove').value = JSON.stringify(filesToRemove);
        
        // 隐藏对应的文件项
        const fileItems = document.querySelectorAll(`#uploaded-files-list .alert`);
        fileItems.forEach(item => {
            const link = item.querySelector('a');
            if (link && link.href.includes(savedName)) {
                item.style.opacity = '0.5';
                item.style.textDecoration = 'line-through';
                const btn = item.querySelector('button');
                if (btn) btn.disabled = true;
            }
        });
    }
    
    // 使用公共函数处理拖拽离开
    function handleDragLeaveEdit(e) {
        handleDragLeaveCommon(e, 'html-upload-area-edit');
    }
    
    // 使用公共函数处理拖拽放置
    function handleDropEdit(e) {
        handleDropCommon(
            e,
            'html-file-input-edit',
            'html-upload-area-edit',
            'upload-text-edit',
            null // 编辑页面不需要立即上传，等表单提交
        );
    }
    
    // 处理多文件选择
    function handleFileSelectEdit(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        // 检查已上传的文件数量
        const existingFiles = document.querySelectorAll('#uploaded-files-list .alert:not([style*="opacity: 0.5"])').length || 0;
        const totalFiles = existingFiles + files.length;
        
        // 限制最多2个文件
        if (totalFiles > 2) {
            alert(`{{ translate('js.max_files_exceeded')|replace('{existing}', '${existingFiles}')|replace('{selected}', '${files.length}') }}`);
            e.target.value = ''; // 清空文件选择
            return;
        }
        
        // 显示选中的文件列表
        const previewDiv = document.getElementById('selected-files-preview');
        const uploadText = document.getElementById('upload-text-edit');
        const filesList = document.getElementById('selected-files-list');
        
        uploadText.style.display = 'none';
        previewDiv.style.display = 'block';
        
        filesList.innerHTML = '';
        files.forEach(file => {
            const li = document.createElement('li');
            li.innerHTML = `<i class="bi bi-file-earmark-code text-primary"></i> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            filesList.appendChild(li);
        });
    }
    
    // 表单提交处理 - 使用Base64编码上传多文件
    document.getElementById('edit-task-form').addEventListener('submit', function(e) {
        const fileInput = document.getElementById('html-file-input-edit');
        const files = Array.from(fileInput.files);
        const submitBtn = document.getElementById('submit-btn');
        
        // 如果有HTML文件，使用Base64编码上传
        if (files.length > 0) {
            e.preventDefault();
            
            // 检查文件大小
            for (let file of files) {
                if (file.size > 16 * 1024 * 1024) {
                    alert(`{{ translate('js.file_size_exceeded')|replace('{name}', '${file.name}') }}`);
                    return false;
                }
            }
            
            // 显示上传状态
            submitBtn.disabled = true;
            submitBtn.textContent = `上传中 (0/${files.length})...`;
            
            // 读取所有文件并编码
            const filesData = [];
            let processedCount = 0;
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onerror = function() {
                    alert(`{{ translate('js.file_read_failed')|replace('{name}', '${file.name}') }}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = '保存修改';
                };
                
                reader.onload = function(e) {
                    const fileContent = e.target.result;
                    const base64Content = btoa(unescape(encodeURIComponent(fileContent)));
                    
                    filesData.push({
                        name: file.name,
                        content: base64Content
                    });
                    
                    processedCount++;
                    submitBtn.textContent = `上传中 (${processedCount}/${files.length})...`;
                    
                    // 所有文件处理完成后提交表单
                    if (processedCount === files.length) {
                        const form = document.getElementById('edit-task-form');
                        
                        // 添加文件数据字段
                        const filesDataInput = document.createElement('input');
                        filesDataInput.type = 'hidden';
                        filesDataInput.name = 'html_files_data';
                        filesDataInput.value = JSON.stringify(filesData);
                        form.appendChild(filesDataInput);
                        
                        // 清空文件输入
                        fileInput.value = '';
                        
                        // 提交表单
                        form.submit();
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            return false;
        }
        
        // 如果没有文件，正常提交
        return true;
    });
</script>
{% endblock %}
{% endblock %}