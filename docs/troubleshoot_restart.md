# QuickForm 约 6 小时后异常 — 原因与排查

你遇到的是：**运行约 6 小时左右服务不再响应请求，进程没有退出，也没有崩溃/报错**。  
下面按两种现象分开说：**不响应（卡死）** 和 **进程退出（崩溃）**。

---

## 现象一：进程还在，但不响应（你的情况）

表现：浏览器打不开、接口无响应，任务管理器里 python 进程仍在，日志没有报错。

### 可能原因

1. **Flask 自带服务器是单线程/单进程**
   - 一旦有一个请求卡住（例如等数据库、等外部接口、死锁），整个进程就无法处理新请求，看起来就像“不响应”。
   - 长时间运行后，若某次请求触发了慢查询、MySQL 连接被服务端断开后重连卡住等，就会表现为“约 6 小时后不响应”。

2. **MySQL 空闲连接被服务端断开**
   - 若用 MySQL，默认约 8 小时空闲会断开连接。若你这边连接池没有 `pool_recycle` / `pool_pre_ping`，下次请求可能用到一个已断开的连接，导致长时间等待或挂起，从而表现为“过一段时间后不响应”。

3. **SSL/网络层挂起**
   - 长时间运行后，个别半开连接、keep-alive 超时等可能导致接受新连接的逻辑卡住（相对少见）。

4. **某段代码阻塞主线程**
   - 例如某次请求里调用了会阻塞的接口（网络、文件、锁），且没有超时，就会拖住整个进程。

### 建议措施（优先做）

| 措施 | 说明 |
|------|------|
| **改用 Waitress** | Waitress 多线程，单个请求卡住不会拖死整个服务。项目内已提供 `run_waitress.py`，在项目根目录执行 `python run_waitress.py` 即可；对外 443 用 IIS 反向代理到 127.0.0.1:8000，或暂时继续用 `python app.py` 跑 443。详见 `docs/windows_deploy.md`。 |
| **MySQL 连接池** | 若用 MySQL，在创建 engine 时加 `pool_pre_ping=True` 和 `pool_recycle=3600`（或更小），避免使用已被服务端断开的连接。 |
| **定时重启（权宜之计）** | 用 NSSM 把 QuickForm 做成服务后，在“任务计划程序”里加一个每 5 小时执行一次的任务：`nssm restart QuickForm`，到点自动重启，减少“长时间不响应”的窗口。 |
| **电源/休眠** | 控制面板 → 电源选项 → 关闭显示器/进入睡眠 设为“从不”，避免 6 小时无操作触发休眠导致网络异常。 |

### 如何确认是不是 MySQL 连接

- 若不响应时日志里**完全没有任何新请求的打印**，多半是主线程被某处阻塞（数据库、网络、锁等）。
- 在 blueprint 里对数据库操作加超时或确认已配置 `pool_pre_ping`、`pool_recycle`，再观察是否还会“约 6 小时不响应”。

---

## 现象二：进程退出（崩溃）

表现：服务彻底打不开，任务管理器里 python 进程消失，可能有异常堆栈或事件查看器记录。

### 可能原因

- 未捕获异常导致进程退出；
- 用户会话结束（关 RDP 窗口、注销）导致该会话下的进程被系统结束；
- 系统/计划任务/安骑士结束进程；
- 内存耗尽等。

### 排查

- 用 NSSM 把 stdout/stderr 重定向到 `C:\QuickForm\app.log`，下次再退出时看日志最后几行；
- 看 Windows 事件查看器“应用程序”“系统”在退出时间点是否有错误或服务终止记录。

### 建议

- 用 NSSM 将 QuickForm 注册为 Windows 服务，并勾选“失败后自动重启”，进程意外退出时会被拉起来。

---

## NSSM 简要步骤（不响应 + 崩溃都适用）

1. 下载 [NSSM](https://nssm.cc/download)，解压到 `C:\nssm`。
2. 管理员 CMD：`cd C:\nssm\win64`，执行 `nssm install QuickForm`。
3. **Application** 页：Path 填 `python.exe` 完整路径，Startup directory 填项目根目录，Arguments 填 `app.py`（若用 Waitress 则填 `-m waitress --host=0.0.0.0 --port=8000 --call app:app`）。
4. **I/O** 页：stdout/stderr 重定向到 `C:\QuickForm\app.log`，勾选 Append。
5. `nssm start QuickForm`；需要开机自启可设 `Start type = Automatic`。

若仍出现“约 6 小时不响应”，优先：**改用 Waitress + MySQL 连接池配置 + 5 小时定时重启**，再根据日志和现象继续收窄原因。
